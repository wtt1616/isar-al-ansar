# iSAR System Updates - November 20, 2025

## Overview
This document summarizes all features and fixes implemented on November 20, 2025.

---

## 1. Preacher Management & Scheduling Modules

### Module 1: Preacher Management (Admin Only)
**Location**: `/preachers/manage`

**Features**:
- Add, edit, and delete preacher information
- Manage active/inactive status
- Email uniqueness validation
- Phone and email contact information

**Files Created**:
- `app/api/preachers/route.ts` - API endpoints (GET, POST, PUT, DELETE)
- `app/preachers/manage/page.tsx` - Admin UI
- `database/schema/preachers.sql` - Database schema

**Database Table**: `preachers`
```sql
- id (INT, PK)
- name (VARCHAR)
- phone (VARCHAR)
- email (VARCHAR, UNIQUE)
- is_active (TINYINT)
- created_at, updated_at (TIMESTAMP)
```

---

### Module 2: Preacher Schedules
**Location**: `/preacher-schedules`

**Features**:
- Monthly calendar view with preacher assignments
- List view for easier data entry
- Special day rules:
  - **Monday & Thursday**: No preaching
  - **Friday**: Only "Friday Preach" (Jumaat)
  - **Other days**: Subuh and Maghrib preaching
- Head Imam can create/edit schedules
- All users can view schedules
- Print functionality for PDF export
- Color-coded display (future enhancement)

**Files Created**:
- `app/api/preacher-schedules/route.ts` - Schedule API
- `app/preacher-schedules/page.tsx` - Schedule UI with calendar/list views
- `database/schema/add_friday_preacher.sql` - Migration for existing installations

**Database Table**: `preacher_schedules`
```sql
- id (INT, PK)
- schedule_date (DATE, UNIQUE)
- subuh_preacher_id (INT, FK to preachers)
- maghrib_preacher_id (INT, FK to preachers)
- friday_preacher_id (INT, FK to preachers)
- notes (TEXT)
- created_by (INT, FK to users)
- created_at, updated_at (TIMESTAMP)
```

**Special Day Logic**:
- Frontend automatically shows/hides slots based on day of week
- Calendar view displays "No Preaching" for Monday/Thursday
- Friday shows only "Friday Preach" slot
- Other days show both Subuh and Maghrib slots

---

## 2. Availability Filtering Fix (Timezone Issue)

### Problem
Imams/Bilals were being filtered on wrong dates due to timezone conversion:
- Database: `2025-11-20`
- JavaScript converted to: `2025-11-19T16:00:00` (timezone offset)
- Result: User marked unavailable on wrong day

### Solution
Used `DATE_FORMAT()` in MySQL to return dates as strings:
```sql
SELECT DATE_FORMAT(a.date, '%Y-%m-%d') as date ...
```

This prevents JavaScript from converting dates to Date objects with timezone offsets.

**Files Modified**:
- `app/api/availability/route.ts` - Added DATE_FORMAT
- `app/schedules/manage/page.tsx` - Improved date handling

**Impact**: Availability filtering now works correctly across all timezones.

---

## 3. Logout Functionality Fix

### Problem
Logout button redirected to `localhost/login` without port number, causing "connection refused" error in development.

### Solution
Changed from:
```typescript
signOut({ callbackUrl: '/login' })
```

To:
```typescript
await signOut({ redirect: false });
window.location.href = '/login';
```

**Files Modified**:
- `components/Navbar.tsx` - Updated logout handler

**Impact**: Logout now works correctly in both development and production.

---

## 4. Production Build Optimization

### Problem
Jest worker errors during production builds on resource-constrained servers:
```
Error: Jest worker encountered 2 child process exceptions
```

### Solution
Updated Next.js configuration to reduce resource usage:
```javascript
experimental: {
  workerThreads: false,
  cpus: 1,
}
swcMinify: true,
```

**Files Modified**:
- `next.config.js` - Added build optimizations

**Impact**: Production builds succeed on servers with limited resources.

---

## 5. Navigation Updates

**Updated**: `components/Navbar.tsx`

**New Links**:
- "Preacher Schedules" (visible to all users)
- "Manage Preachers" (visible to admin only)

**Navigation Structure**:
```
- Dashboard (all users)
- Manage Schedules (head_imam, admin)
- Preacher Schedules (all users)
- My Availability (imam, bilal)
- Manage Users (admin)
- Manage Preachers (admin)
```

---

## Database Migration Instructions

### For Fresh Installations
Run the complete schema:
```bash
mysql -u user -p database < database/schema/preachers.sql
```

### For Existing Installations
Run the migration to add friday_preacher_id:
```bash
mysql -u user -p database < database/schema/add_friday_preacher.sql
```

---

## Local Testing Checklist

- [x] Admin can add/edit/delete preachers
- [x] Head Imam can create monthly preacher schedules
- [x] Monday/Thursday show "No Preaching"
- [x] Friday shows only "Friday Preach" slot
- [x] Other days show Subuh and Maghrib slots
- [x] Calendar and List views work correctly
- [x] Print functionality works
- [x] Availability filtering works correctly
- [x] Logout redirects to login page

---

## Production Deployment Steps

### 1. SSH to Production Server
```bash
ssh myopensoft-isar@isar.myopensoft.net -p 8288
```

### 2. Navigate to App Directory
```bash
cd ~/isar
```

### 3. Pull Latest Code
```bash
git pull origin main
```

### 4. Run Database Migrations
```bash
# Find your database name
cat .env | grep DB_NAME

# Run migrations
mysql -h isar.myopensoft.net -u myopensoft-isar -p YOUR_DB_NAME < database/schema/add_friday_preacher.sql
```

### 5. Install Dependencies & Build
```bash
npm install
rm -rf .next
npm run build
```

### 6. Restart Application
```bash
pm2 restart isar
pm2 logs isar --lines 20
```

---

## Git Commits

All changes were committed with detailed messages:

1. `dec785a` - Add preacher management and scheduling modules
2. `f2054ff` - Update preacher schedules for special day rules
3. `23b8941` - Fix Jest worker error on production builds
4. `9c66f80` - Fix timezone conversion issue in availability API
5. `eba2575` - Fix timezone conversion issue in availability filtering (final)
6. `4db4bf8` - Fix logout redirect to preserve port number

---

## Security Considerations

### Role-Based Access Control
- **Admin**: Full CRUD on preachers
- **Head Imam**: Create/edit preacher schedules
- **All Users**: View schedules
- **Session Validation**: All APIs check authentication

### Data Validation
- Email uniqueness enforcement
- Required field validation
- SQL injection prevention (parameterized queries)
- Foreign key constraints with CASCADE rules

---

## Future Enhancements

### Potential Improvements
1. **Auto-Schedule Algorithm**: Automatically distribute preachers evenly
2. **Conflict Detection**: Warn if same preacher assigned multiple times
3. **Email Notifications**: Notify preachers of their assignments
4. **Statistics Dashboard**: Track preaching frequency per preacher
5. **Export to Excel/PDF**: Advanced export options
6. **Mobile Optimization**: Improve mobile interface
7. **Color Coding**: Assign colors to preachers like imam/bilal schedules

---

## Known Issues

None at this time. All reported issues have been resolved.

---

## Dependencies

No new dependencies added. All features use existing packages:
- `next` - Framework
- `next-auth` - Authentication
- `mysql2` - Database
- `react` - UI
- `bootstrap` - Styling

---

## Testing Notes

### Timezone Testing
- Tested with Malaysia timezone (GMT+8)
- Dates now display correctly without timezone shift
- Availability filtering works across date boundaries

### Special Days Testing
- Monday: Confirmed "No Preaching" display
- Thursday: Confirmed "No Preaching" display
- Friday: Confirmed only "Friday Preach" slot appears
- Other days: Confirmed Subuh and Maghrib slots appear

### Browser Compatibility
- Tested on Chrome
- Tested on Firefox
- Print functionality works on modern browsers

---

## Performance Considerations

### Database Queries
- Indexed on `schedule_date` for fast date lookups
- Indexed on preacher IDs for fast joins
- Uses `DATE_FORMAT` to prevent timezone overhead

### Frontend
- Calendar generates 42 days (6 weeks) for month view
- Efficient Map-based unavailability checking
- React state management for real-time updates

---

**Last Updated**: 2025-11-20
**Created By**: Claude Code
**Version**: iSAR v1.4
